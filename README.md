# SecureIM - 安全即时通讯软件

SecureIM 是一个用 Python 构建的、注重隐私和安全的即时通讯桌面应用程序。它采用先进的混合加密方案，集成了对称（AES-GCM）和非对称（RSA-OAEP）加密的优点，确保所有通信的端到端安全。应用支持通过服务器中继消息（C/S模式）和直接的点对点连接（P2P模式），为用户在不同网络环境下提供灵活、高效且可靠的通讯体验。

## 📂 项目结构

```
SecureIM/
├── .secure_im/           # (自动创建于用户主目录) 用于存储客户端本地的RSA私钥。
│   └── private_key.pem
├── data/                 # (自动创建于项目根目录) 用于存储服务器相关数据。
│   └── server.db         # 服务器端SQLite数据库文件，存储用户信息、好友关系等。
├── README.md               # 文档。
├── requirements.txt        # 项目运行所需的Python第三方库。
├── run_client.py           # 客户端应用程序的启动脚本。
├── run_server.py           # 服务器应用程序的启动脚本。
└── src/
    └── secureim/
        ├── __init__.py
        ├── client/
        │   ├── __init__.py
        │   ├── main.py             # 客户端入口，负责UI和业务逻辑的协调。
        │   ├── logic.py            # 客户端核心业务逻辑，处理加密、P2P、状态管理等。
        │   ├── networking.py       # 封装客户端所有网络通信（服务器和P2P）。
        │   └── ui/
        │       ├── __init__.py
        │       ├── login_window.py # 登录与注册窗口的UI定义。
        │       └── main_window.py  # 主聊天窗口的UI定义。
        │   └── utils/
        │       ├── __init__.py
        │       ├── crypto.py       # 封装了所有加密/解密操作的工具模块。
        │       └── steganography.py# 实现了隐写术功能的工具模块。
        └── server/
            ├── __init__.py
            ├── main.py             # 服务器入口，负责启动和监听。
            ├── ai.py               # 服务器AI模块。
            ├── connection_handler.py # 处理每一个独立的客户端连接和会话。
            ├── request_handler.py  # 解析并处理客户端发送的各种业务请求。
            ├── state.py            # 维护服务器的共享状态（如在线用户列表）。
            └── database.py         # 数据库交互模块，封装所有SQL操作。

```

## ✨ 主要功能

- **🔒 端到端加密 (E2EE)**: 所有消息、文件和元数据均使用AES-256-GCM进行加密，确保只有对话双方能够解密和阅读内容。会话密钥的交换通过RSA-4096非对称加密保护，杜绝了中间人攻击的风险。
- **👥 账户安全与验证**:
    - **强制邮箱验证**：用户注册时必须提供有效的邮箱地址，并通过接收验证码来完成账户激活，防止恶意注册。
    - **修改密码**：用户可以自行修改密码，系统会要求验证邮箱，确保密码更改过程的安全性。
    - **强密码策略**：密码长度被强制要求至少为8位，并且必须包含字母和数字的组合，增加了暴力破解的难度。
    - **灵活登录**：支持使用注册时绑定的 **用户名** 或 **邮箱** 进行登录，方便用户记忆。
- **🌐 混合通信模式**:
    - **C/S (客户端/服务器) 模式**: 作为默认通信模式，所有消息通过服务器进行安全中继。此模式保证了即使在复杂的NAT环境下也能可靠通信。服务器终端会实时打印中继日志，便于管理员监控服务状态。
    - **P2P (点对点) 模式**: 用户可以主动与好友尝试建立直接的点对点连接。一旦P2P连接成功，消息将不再经过服务器，从而实现更低的延迟和更强的私密性。
    - **动态连接状态反馈**: 客户端界面会明确提示P2P连接的 **"正在尝试..."**、**"成功"** 或 **"失败"** 状态，让用户清晰地了解当前的通信模式。
- **🖼️ 隐写术 (Steganography)**: 提供将敏感文本消息隐藏在图片中的独特功能。发送的图片看起来与普通图片无异，但接收方可以从中提取隐藏信息，为关键通信提供双重安全保障。
- **📄 安全文件传输**: 支持在加密会话中安全地发送和接收任意类型的文件。文件在发送前进行加密，在接收后解密，确保传输过程的机密性。
- **📝 用户界面**: 使用PyQt6构建的图形用户界面，提供直观、易用的操作体验。界面设计简洁明了，提供多种聊天气泡。
- **🟢 好友系统与实时在线状态**: 用户可以添加和管理好友联系人，并能够实时查看好友的在线状态（在线/离线），便于选择最佳的沟通时机。
- **🖥️ 跨平台设计**: 基于 Python 和 PyQt6 图形库构建，使其能够轻松地在 Windows、macOS 和 Linux 等主流操作系统上运行。
- **🤖 人工智能助手**: 用户可以与人工智能助手进行交互，获取智能建议和帮助。

## 🔑 密钥管理

客户端在首次启动时，会为用户自动生成一对唯一的RSA-4096公私钥。私钥是安全通信的核心，用于解密会话密钥。

- **存储位置**: 私钥被安全地存储在用户主目录下的一个隐藏文件夹 `.secure_im` 中。
    - **Windows**: `C:\\Users\\<YourUsername>\\.secure_im\\private_key.pem`
    - **Linux/macOS**: `/home/<YourUsername>/.secure_im/private_key.pem`
- **安全提示**: 此文件包含了您的身份认证信息，**请勿删除、移动或与任何人分享**。

## 🚀 如何运行

### 1. 环境设置

将本仓库克隆到本地计算机：
```bash
git clone https://github.com/your-username/SecureIM.git
```

建议创建一个Python虚拟环境来隔离项目依赖：
```bash
python -m venv venv
# Windows
venv\\Scripts\\activate
# macOS/Linux
source venv/bin/activate
```

安装所有必需的依赖项：
```bash
pip install -r requirements.txt
```

### 2. 配置服务器

在logic.py中，配置服务器地址和端口：
```
# logic.py
SERVER_ADDRESS = '127.0.0.1' # 替换为实际服务器地址
SERVER_PORT = 12345 # 替换为实际服务器端口
```

在ai.py中，配置AI助手：
```
# ai.py
API_URL = "http://127.0.0.1:1234/v1/chat/completions" # 替换为实际API地址
API_KEY = "key"                # 替换为实际API密钥
MODEL = "model"            # 替换为实际模型
```

在request_handler.py中，配置邮件服务器：
```
# request_handler.py
# 邮件服务器配置 - 如果sender_email为空，则使用模拟邮箱
EMAIL_CONFIG = {
    'smtp_server': 'smtp.qq.com',
    'smtp_port': 587,
    'sender_email': '',  # 留空则使用模拟邮箱，填写则使用真实SMTP
    'sender_password': '',  # 邮箱授权码
    'sender_name': 'SecureIM验证服务'
}
```

### 3. 运行服务器

服务器必须在任何客户端连接之前启动。它负责处理用户注册、登录验证、消息中继以及P2P连接协调。

在项目根目录下打开一个终端并运行：
```bash
python run_server.py
```

### 4. 运行客户端

可以启动多个客户端实例来模拟不同用户之间的对话。

为每一个需要模拟的用户 **打开一个新的终端**，并确保虚拟环境已激活。然后在项目根目录下运行：
```bash
python run_client.py
```

- **首次运行**: 第一次运行客户端时，自动在用户主目录下创建 `.secure_im/private_key.pem` 文件来存储私钥。
- **注册**: 在第一个客户端上，点击"注册"按钮。使用一个唯一的用户名、符合策略的密码和一个有效的电子邮箱地址来创建一个新帐户。
- **登录**: 注册成功后，使用刚刚创建的 **用户名** 或 **邮箱** 及密码进行登录。
- **添加好友**: 与朋友（即另一个客户端实例）交换用户名，然后通过"添加好友"功能将对方添加为联系人。
- **开始聊天**: 在好友列表中选择一个在线的好友即可开始安全通信。默认情况下，所有消息将通过服务器中继（C/S模式）。
- **切换到P2P模式**: 在好友列表上右键点击一个在线好友，选择"切换到P2P模式"。界面将实时显示P2P连接的状态。

## 🛠️ 技术栈

- **核心语言**: Python 3
- **图形用户界面 (GUI)**: PyQt6
- **核心加密库**: `cryptography` (用于实现 RSA-OAEP 和 AES-GCM)
- **图像处理与隐写**: `Pillow`
- **本地数据库**: `sqlite3` (通过Python内置库)
- **邮件服务**: `smtplib` (用于发送注册验证邮件)
